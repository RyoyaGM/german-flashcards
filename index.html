<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ドイツ語単語学習アプリ - 総合学術単語</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; -webkit-tap-highlight-color: transparent; }
        .flip-card-inner { transition: transform 0.6s; transform-style: preserve-3d; }
        .flip-card.flipped .flip-card-inner { transform: rotateX(180deg); }
        .flip-card-front, .flip-card-back { -webkit-backface-visibility: hidden; backface-visibility: hidden; }
        .flip-card-back { transform: rotateX(180deg); }
        .btn { transition: all 0.2s ease-in-out; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
        .btn:active:not(:disabled) { transform: translateY(0); box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .screen { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        #word-list-container::-webkit-scrollbar, #text-display-container::-webkit-scrollbar { width: 8px; }
        #word-list-container::-webkit-scrollbar-track, #text-display-container::-webkit-scrollbar-track { background: #f1f5f9; }
        .dark #word-list-container::-webkit-scrollbar-track, .dark #text-display-container::-webkit-scrollbar-track { background: #374151; }
        #word-list-container::-webkit-scrollbar-thumb, #text-display-container::-webkit-scrollbar-thumb { background: #60a5fa; border-radius: 4px; }
        #word-list-tbody tr { cursor: pointer; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 flex items-center justify-center min-h-screen p-4">

    <div id="app" class="w-full max-w-2xl mx-auto">

        <div id="start-screen" class="screen text-center p-8 bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 relative">
             <button id="sound-toggle-btn" class="btn absolute top-4 right-4 p-2 rounded-full bg-gray-200 dark:bg-gray-700">
                <svg id="sound-on-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600 dark:text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>
                <svg id="sound-off-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600 dark:text-gray-300 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15zM17 14l2-2m0 0l2-2m-2 2L17 10m2 2l2 2" /></svg>
            </button>
            <h1 class="text-3xl md:text-4xl font-bold text-blue-600 dark:text-blue-400 mb-2">ドイツ語単語学習</h1>
            <p class="text-gray-500 dark:text-gray-400 mb-8">総合学術単語</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="start-quiz-btn" class="btn w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md text-lg">全単語クイズ</button>
                <button id="random-10-quiz-btn" class="btn w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-6 rounded-lg shadow-md text-lg">ランダム10問クイズ</button>
                <button id="start-review-quiz-btn" class="btn w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg shadow-md text-lg" disabled>不安な単語クイズ</button>
                <button id="view-list-btn" class="btn w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow-md text-lg">単語を一覧・選択する</button>
                <button id="read-texts-btn" class="btn w-full md:col-span-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-md text-lg" disabled>難解な文章を読む</button>
            </div>
            <p id="review-info" class="text-xs text-gray-400 mt-2 hidden">`review_words.json`が見つからないため無効です。</p>
            <p id="texts-info" class="text-xs text-gray-400 mt-2 hidden">`texts.json`が見つからないため無効です。</p>
            <p id="resume-text" class="text-sm text-gray-500 dark:text-gray-400 mt-6 hidden">
                前回の学習データがあります。<a href="#" id="resume-quiz-btn" class="text-blue-600 dark:text-blue-400 hover:underline">ここから再開</a>
            </p>
        </div>

        <div id="text-reader-screen" class="hidden screen p-6 bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-indigo-600 dark:text-indigo-400">難解な文章を読む</h2>
                <button id="back-to-start-from-text-btn" class="btn bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-bold py-2 px-4 rounded-lg">戻る</button>
            </div>
            <div id="text-display-container" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                <div class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                    <p class="font-bold mb-2">ドイツ語原文</p>
                    <p id="german-text-display" class="text-lg leading-relaxed"></p>
                </div>
                <div id="japanese-text-container" class="hidden">
                    <button id="show-japanese-btn" class="btn w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 rounded-lg">日本語訳を表示</button>
                    <div id="japanese-text-content" class="hidden p-4 mt-2 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                        <p class="font-bold mb-2">日本語訳</p>
                        <p id="japanese-text-display" class="leading-relaxed"></p>
                    </div>
                </div>
                <div id="explanation-container" class="hidden">
                    <button id="show-explanation-btn" class="btn w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 rounded-lg">文法解説を表示</button>
                    <div id="explanation-content" class="hidden p-4 mt-2 bg-green-50 dark:bg-green-900/30 rounded-lg">
                        <p class="font-bold mb-2">文法解説</p>
                        <p id="explanation-display" class="leading-relaxed"></p>
                    </div>
                </div>
            </div>
            <div class="mt-4 text-center">
                <button id="next-text-btn" class="btn w-full bg-gray-800 hover:bg-gray-900 dark:bg-gray-200 dark:hover:bg-gray-300 text-white dark:text-black font-bold py-3 px-6 rounded-lg shadow-md">次の文章へ</button>
            </div>
        </div>
        
        </div>

    <script>
        // ... (以前のスクリプトの大部分) ...
        
        // --- Audio Setup ---
        const sounds = {
            click: new Audio('決定ボタンを押す34.mp3'),
            flip: new Audio('https://cdn.jsdelivr.net/gh/kristopolous/music/sounds/button-1.mp3')
        };
        let audioContextUnlocked = false;
        let isSoundEnabled = true;

        function unlockAudioContext() {
            if (audioContextUnlocked) return;
            const context = new (window.AudioContext || window.webkitAudioContext)();
            if (context.state === 'suspended') {
                context.resume();
            }
            audioContextUnlocked = true;
        }
        document.body.addEventListener('click', unlockAudioContext, { once: true });
        
        function playSound(sound) {
            if (!audioContextUnlocked || !isSoundEnabled) return;
            sound.currentTime = 0;
            sound.play().catch(e => {});
        }

        // --- DOM Elements (追加) ---
        const textReaderScreen = document.getElementById('text-reader-screen');
        const readTextsBtn = document.getElementById('read-texts-btn');
        const textsInfo = document.getElementById('texts-info');
        const germanTextDisplay = document.getElementById('german-text-display');
        const japaneseTextContainer = document.getElementById('japanese-text-container');
        const showJapaneseBtn = document.getElementById('show-japanese-btn');
        const japaneseTextContent = document.getElementById('japanese-text-content');
        const japaneseTextDisplay = document.getElementById('japanese-text-display');
        const explanationContainer = document.getElementById('explanation-container');
        const showExplanationBtn = document.getElementById('show-explanation-btn');
        const explanationContent = document.getElementById('explanation-content');
        const explanationDisplay = document.getElementById('explanation-display');
        const nextTextBtn = document.getElementById('next-text-btn');
        const backToStartFromTextBtn = document.getElementById('back-to-start-from-text-btn');
        
        // --- State (追加) ---
        let allTexts = [], currentTextIndex = 0;

        // --- Text Reader Logic ---
        function showText(index) {
            const text = allTexts[index];
            germanTextDisplay.textContent = text.german;
            japaneseTextDisplay.textContent = text.japanese;
            explanationDisplay.textContent = text.explanation;

            japaneseTextContainer.classList.remove('hidden');
            explanationContainer.classList.remove('hidden');
            japaneseTextContent.classList.add('hidden');
            explanationContent.classList.add('hidden');
            showJapaneseBtn.classList.remove('hidden');
            showExplanationBtn.classList.remove('hidden');
        }

        // --- Initialization (修正) ---
        async function initializeApp() {
            const savedSoundSetting = localStorage.getItem(SOUND_SETTING_KEY);
            isSoundEnabled = savedSoundSetting === null ? true : savedSoundSetting === 'true';
            updateSoundIcon();

            try {
                // 単語データの読み込み
                const wordsResponse = await fetch('words.json');
                if (!wordsResponse.ok) throw new Error(`words.jsonの読み込みに失敗`);
                allWords = await wordsResponse.json();
                
                // 復習単語データの読み込み
                try {
                    const reviewResponse = await fetch('review_words.json');
                    if (reviewResponse.ok) {
                        reviewWords = await reviewResponse.json();
                        startReviewQuizBtn.disabled = reviewWords.length === 0;
                        reviewInfo.classList.toggle('hidden', reviewWords.length > 0);
                    } else { reviewInfo.classList.remove('hidden'); }
                } catch (e) { reviewInfo.classList.remove('hidden'); }

                // 文章データの読み込み
                try {
                    const textsResponse = await fetch('texts.json');
                    if (textsResponse.ok) {
                        allTexts = await textsResponse.json();
                        readTextsBtn.disabled = allTexts.length === 0;
                        textsInfo.classList.toggle('hidden', allTexts.length > 0);
                    } else { textsInfo.classList.remove('hidden'); }
                } catch (e) { textsInfo.classList.remove('hidden'); }

                showScreen('start');
                const savedProgress = loadProgress();
                resumeText.classList.toggle('hidden', !savedProgress);
            } catch (error) {
                console.error("初期化エラー:", error);
                document.getElementById('app').innerHTML = `<p class="text-red-500 text-center font-bold">エラー: ${error.message}。<br>ファイルが存在するか確認してください。</p>`;
            }
        }
        
        // --- Event Listeners (追加と修正) ---
        readTextsBtn.addEventListener('click', () => {
            if (allTexts.length > 0) {
                shuffleArray(allTexts);
                currentTextIndex = 0;
                showText(currentTextIndex);
                showScreen('textReader');
            }
        });

        nextTextBtn.addEventListener('click', () => {
            currentTextIndex = (currentTextIndex + 1) % allTexts.length;
            showText(currentTextIndex);
        });

        showJapaneseBtn.addEventListener('click', () => {
            japaneseTextContent.classList.remove('hidden');
            showJapaneseBtn.classList.add('hidden');
        });

        showExplanationBtn.addEventListener('click', () => {
            explanationContent.classList.remove('hidden');
            showExplanationBtn.classList.add('hidden');
        });

        backToStartFromTextBtn.addEventListener('click', () => {
            showScreen('start');
            initializeApp();
        });

        // (既存のイベントリスナーはそのまま)
        // ...
    </script>
</body>
</html>
